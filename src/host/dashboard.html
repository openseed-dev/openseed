<!DOCTYPE html>
<html>
<head>
  <title>itsalive</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      background: #0a0a0a; color: #ccc; font-size: 13px;
      display: flex;
    }

    .sidebar {
      position: sticky; top: 0; height: 100vh;
      width: 220px; border-right: 1px solid #222;
      display: flex; flex-direction: column; flex-shrink: 0;
      overflow-y: auto;
    }
    .sidebar-header {
      padding: 16px; color: #0f0; font-size: 16px; font-weight: bold;
      border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-header .spawn-btn {
      background: none; border: 1px solid #333; color: #666;
      width: 22px; height: 22px; border-radius: 3px; cursor: pointer;
      font-size: 16px; line-height: 1; display: flex; align-items: center; justify-content: center;
    }
    .sidebar-header .spawn-btn:hover { color: #0f0; border-color: #0f0; }
    .spawn-form {
      display: none; padding: 12px; border-bottom: 1px solid #222; background: #111;
    }
    .spawn-form.visible { display: flex; flex-direction: column; gap: 8px; }
    .spawn-form input, .spawn-form textarea, .spawn-form select {
      background: #0a0a0a; border: 1px solid #333; color: #eee;
      padding: 6px 8px; border-radius: 3px; font-family: inherit; font-size: 12px;
    }
    .spawn-form input:focus, .spawn-form textarea:focus, .spawn-form select:focus { outline: none; border-color: #58f; }
    .spawn-form textarea { resize: vertical; min-height: 48px; }
    .spawn-form button {
      background: #1a2a1a; border: 1px solid #0f0; color: #0f0;
      padding: 6px 12px; border-radius: 3px; cursor: pointer;
      font-family: inherit; font-size: 12px;
    }
    .spawn-form button:hover { background: #2a3a2a; }
    .spawn-form button:disabled { opacity: 0.4; cursor: not-allowed; }
    .spawn-form .spawn-error { color: #f55; font-size: 11px; }
    .creature-list { padding: 8px; flex: 1; }
    .creature-item {
      padding: 8px 12px; border-radius: 4px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; margin-bottom: 2px;
    }
    .creature-item:hover { background: #1a1a1a; }
    .creature-item.selected { background: #1a1a2a; border-left: 2px solid #58f; }
    .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot.stopped { background: #555; }
    .dot.starting { background: #fa0; }
    .dot.running { background: #0f0; }
    .dot.sleeping { background: #f80; }
    .dot.error { background: #f33; animation: pulse-error 1s ease-in-out infinite; }
    @keyframes pulse-error { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .cname { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .creature-cost { color: #f80; font-size: 10px; margin-left: 4px; flex-shrink: 0; }
    .btn {
      background: #222; border: 1px solid #333; color: #aaa;
      padding: 2px 6px; border-radius: 3px; cursor: pointer;
      font-family: inherit; font-size: 11px;
    }
    .btn:hover { background: #333; color: #fff; }

    .main {
      flex: 1; min-width: 0; display: flex; flex-direction: column;
    }
    .main-header {
      position: sticky; top: 0; z-index: 20; background: #0a0a0a;
      padding: 12px 16px; border-bottom: 1px solid #222;
      display: flex; align-items: center; gap: 12px;
    }
    .main-header h2 { color: #eee; font-size: 14px; margin: 0; }
    .main-header .info { color: #555; font-size: 12px; }
    .main-header .sha { color: #58f; }

    .tab-bar {
      position: sticky; top: 44px; z-index: 15; background: #0a0a0a;
      display: none; border-bottom: 1px solid #222;
      padding: 0 16px;
    }
    .tab-bar.visible { display: flex; }
    .tab {
      padding: 8px 16px; cursor: pointer; color: #666;
      font-size: 12px; border-bottom: 2px solid transparent;
    }
    .tab:hover { color: #aaa; }
    .tab.active { color: #58f; border-bottom-color: #58f; }
    .tab-refresh {
      margin-left: auto; padding: 8px 12px; cursor: pointer;
      color: #444; font-size: 12px;
    }
    .tab-refresh:hover { color: #888; }

    .content { padding: 16px; flex: 1; }
    .events { display: flex; flex-direction: column; gap: 2px; }

    .event { padding: 6px 12px; border-radius: 4px; border-left: 3px solid #333; background: #111; }
    .event .time { color: #555; font-size: 11px; }
    .event .clabel { color: #58f; font-size: 11px; margin-left: 4px; font-weight: bold; }
    .event .type { font-weight: bold; margin-left: 8px; }

    .event.host-boot { border-left-color: #666; }
    .event.host-spawn { border-left-color: #58f; }
    .event.host-promote { border-left-color: #0f0; }
    .event.host-rollback { border-left-color: #f33; background: #1a0808; }
    .event.creature-boot { border-left-color: #58f; }
    .event.creature-thought { border-left-color: #888; }
    .event.creature-sleep { border-left-color: #fa0; }
    .event.creature-wake { border-left-color: #0af; }
    .event.creature-message { border-left-color: #58f; background: #0a0a1a; }
    .event.creature-tool-call { border-left-color: #0af; }
    .event.creature-tool-call.browser { border-left-color: #a6e; }
    .event.creature-tool-call.fail { border-left-color: #f55; }
    .event.creature-dream { border-left-color: #a6e; background: #0f0a15; }
    .event.creature-dream.deep { border-left-color: #c8f; background: #120a1a; }
    .event.creature-progress-check { border-left-color: #f80; background: #1a1208; }
    .event.creature-error { border-left-color: #f33; background: #1a0808; }
    .event.creature-error .retry-badge { color: #f55; font-size: 11px; margin-left: 6px; }
    .event.creator-evaluation { border-left-color: #0d4; background: #081a0a; }

    .event .type.host { color: #666; }
    .event .type.promote { color: #0f0; }
    .event .type.rollback { color: #f33; }
    .event .type.sleep { color: #fa0; }
    .event .type.wake { color: #0af; }
    .event .type.message { color: #58f; }
    .event .type.tool { color: #0af; }
    .event .type.tool.browser { color: #a6e; }
    .event .type.tool.fail { color: #f55; }
    .event .type.thought { color: #aaa; }
    .event .type.dream { color: #a6e; font-style: italic; }
    .event .type.dream.deep { color: #c8f; font-weight: bold; }
    .event .type.progress-check { color: #f80; }
    .event .type.creator { color: #0d4; font-weight: bold; }
    .event .type.boot { color: #58f; }

    .intent-text { color: #eee; margin-left: 4px; white-space: pre-wrap; }
    .thought-summary { cursor: pointer; }
    .thought-summary:hover { text-decoration: underline; }
    .thought-body { display: none; margin-top: 6px; padding: 8px; background: #0d0d0d; border-radius: 4px; white-space: pre-wrap; word-break: break-word; color: #aaa; font-size: 12px; }
    .thought-body.open { display: block; }
    .tool-cmd { color: #fff; background: #1a1a2a; padding: 2px 6px; border-radius: 3px; margin-left: 6px; }
    .tool-status { margin-left: 6px; font-size: 11px; }
    .tool-status.ok { color: #0f0; }
    .tool-status.err { color: #f55; }
    .tool-output { display: block; color: #888; margin-top: 4px; padding: 6px 8px; background: #0d0d0d; border-radius: 3px; white-space: pre-wrap; word-break: break-all; font-size: 12px; }
    .tool-ms { color: #555; font-size: 11px; margin-left: 6px; }
    .tool-detail { white-space: pre-wrap; word-break: break-all; font-size: 12px; color: #888; padding: 8px; background: #0d0d0d; border-radius: 4px; margin-top: 6px; }
    .tool-detail-cmd { margin-bottom: 6px; }
    .tool-detail-out { border-top: 1px solid #222; padding-top: 6px; }
    .sha { color: #58f; }
    .detail { color: #888; margin-left: 4px; }

    .message-bar {
      position: sticky; bottom: 0; background: #0a0a0a;
      padding: 12px 16px; border-top: 1px solid #222;
      display: none; gap: 8px;
    }
    .message-bar.visible { display: flex; }
    .message-bar textarea {
      flex: 1; background: #111; border: 1px solid #333;
      color: #eee; padding: 8px 12px; border-radius: 4px;
      font-family: inherit; font-size: 13px;
      resize: vertical; min-height: 38px; max-height: 200px;
    }
    .message-bar textarea:focus { outline: none; border-color: #58f; }
    .message-bar button {
      background: #1a1a2a; border: 1px solid #58f; color: #58f;
      padding: 8px 16px; border-radius: 4px; cursor: pointer;
      font-family: inherit; font-size: 13px;
    }
    .message-bar button:hover { background: #2a2a4a; }

    .mind-content {
      word-break: break-word;
      font-size: 12px; color: #bbb; line-height: 1.5;
    }
    .mind-content.pre { white-space: pre-wrap; }
    .mind-content .jsonl-entry { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #1a1a1a; }
    .mind-content .jsonl-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .mind-content .jsonl-time { color: #666; font-size: 11px; }
    .mind-content .jsonl-summary { color: #ccc; margin-top: 4px; }
    .mind-content h1 { color: #fff; font-size: 15px; margin: 16px 0 8px; }
    .mind-content h2 { color: #eee; font-size: 14px; margin: 14px 0 6px; }
    .mind-content h3 { color: #ddd; font-size: 13px; margin: 12px 0 4px; }
    .mind-content p { margin: 4px 0; }
    .mind-content li { margin: 2px 0; }
    .mind-content a { color: #58f; }
    .mind-content code { background: #1a1a2a; padding: 1px 4px; border-radius: 3px; font-size: 12px; }
    .mind-content pre { background: #0d0d0d; padding: 8px; border-radius: 4px; overflow-x: auto; margin: 8px 0; }
    .mind-content pre code { background: none; padding: 0; }
    .mind-content ul, .mind-content ol { padding-left: 20px; margin: 6px 0; }
    .mind-content blockquote { border-left: 3px solid #333; padding-left: 12px; color: #999; margin: 8px 0; }
    .mind-content table { border-collapse: collapse; margin: 8px 0; }
    .mind-content th, .mind-content td { border: 1px solid #333; padding: 4px 8px; font-size: 12px; }
    .mind-content th { background: #1a1a1a; color: #ddd; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <span>itsalive</span>
      <button class="spawn-btn" onclick="toggleSpawnForm()" title="Spawn new creature">+</button>
    </div>
    <div class="spawn-form" id="spawnForm">
      <input id="spawnName" placeholder="name (lowercase)" maxlength="32" />
      <select id="spawnGenome">
        <option value="dreamer">dreamer</option>
        <option value="minimal">minimal</option>
      </select>
      <select id="spawnModel">
        <option value="">model (default: opus)</option>
        <option value="claude-opus-4-6">claude-opus-4-6 ($5/$25)</option>
        <option value="claude-sonnet-4-5">claude-sonnet-4-5 ($3/$15)</option>
        <option value="claude-haiku-4-5">claude-haiku-4-5 ($1/$5)</option>
        <option value="gpt-5.2">gpt-5.2 ($1.75/$14)</option>
        <option value="gpt-5-mini">gpt-5-mini ($0.25/$2)</option>
        <option value="o4-mini">o4-mini ($1.10/$4.40)</option>
      </select>
      <textarea id="spawnPurpose" placeholder="purpose (optional)" rows="3"></textarea>
      <button id="spawnBtn" onclick="spawnC()">spawn</button>
      <div class="spawn-error" id="spawnError"></div>
    </div>
    <div class="creature-list" id="creatures"></div>
  </div>
  <div class="main">
    <div class="main-header" id="header">
      <h2>all creatures</h2>
    </div>
    <div class="tab-bar" id="tabbar"></div>
    <div class="content" id="content">
      <div class="events" id="events"></div>
    </div>
    <div class="message-bar" id="msgbar">
      <textarea id="msg" placeholder="Message to creature... (Cmd+Enter to send)" rows="2" onkeydown="if(event.key==='Enter'&&event.metaKey){event.preventDefault();sendMsg()}"></textarea>
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script>
    let selected = null;
    let creatures = {};
    let selectedTab = 'log';
    let mindData = null;
    const eventsEl = document.getElementById('events');
    const headerEl = document.getElementById('header');
    const tabBar = document.getElementById('tabbar');
    const contentEl = document.getElementById('content');
    const msgBar = document.getElementById('msgbar');

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function ts(t) { return t ? t.slice(11, 19) : ''; }
    function toggle(id) { document.getElementById(id)?.classList.toggle('open'); }
    function summarize(text, max) {
      if (!text) return '...';
      const line = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'))[0] || text.trim();
      return line.length > max ? line.slice(0, max) + '...' : line;
    }

    function timeAgo(iso) {
      if (!iso) return '';
      const now = Date.now(), then = new Date(iso).getTime();
      const s = Math.floor((now - then) / 1000);
      if (s < 60) return 'just now';
      if (s < 3600) return Math.floor(s/60) + 'm ago';
      if (s < 86400) return Math.floor(s/3600) + 'h ago';
      if (s < 172800) return 'yesterday';
      return Math.floor(s/86400) + 'd ago';
    }

    function uid() { return 'u' + Date.now() + Math.random().toString(36).slice(2,6); }

    function renderEvent(ev, showCreature) {
      const t = ev.type;
      let cls = t.replace(/\./g, '-');
      let body = '';
      const cl = showCreature && ev.creature ? '<span class="clabel">' + esc(ev.creature) + '</span>' : '';

      if (t === 'creature.sleep') {
        const secs = ev.seconds || 30;
        const acts = ev.actions || 0;
        const id = uid();
        body = cl + '<span class="type sleep">sleep</span>'
          + '<span class="tool-ms">' + secs + 's / ' + acts + ' actions</span>'
          + '<span class="intent-text thought-summary" onclick="toggle(\''+id+'\')"> \u2014 ' + esc(summarize(ev.text, 120)) + '</span>'
          + '<div class="thought-body" id="'+id+'">' + esc(ev.text || '') + '</div>';
      } else if (t === 'creature.wake') {
        body = cl + '<span class="type wake">wake</span>'
          + '<span class="tool-ms">' + esc(ev.source || '') + '</span>'
          + '<span class="detail"> \u2014 ' + esc(ev.reason || '') + '</span>';
      } else if (t === 'creature.message') {
        body = cl + '<span class="type message">' + esc(ev.source || 'user') + '</span>'
          + '<span class="intent-text"> ' + esc(ev.text || '') + '</span>';
      } else if (t === 'creature.tool_call') {
        const tn = ev.tool || 'bash';
        const br = tn === 'browser';
        cls += ev.ok ? '' : ' fail';
        cls += br ? ' browser' : '';
        const tc = 'type tool' + (br ? ' browser' : '') + (ev.ok ? '' : ' fail');
        const oid = uid();
        const cmdPreview = (ev.input || '').length > 80 ? (ev.input || '').slice(0,80) + '...' : (ev.input || '');
        body = cl + '<span class="' + tc + ' thought-summary" onclick="toggle(\''+oid+'\')">\u25b6 ' + esc(tn) + '</span>'
          + '<code class="tool-cmd thought-summary" onclick="toggle(\''+oid+'\')"> ' + esc(cmdPreview) + '</code>'
          + (ev.ok ? '<span class="tool-status ok">ok</span>' : '<span class="tool-status err">fail</span>')
          + '<span class="tool-ms">' + (ev.ms||0) + 'ms</span>'
          + '<div class="tool-detail thought-body" id="'+oid+'">'
          + '<div class="tool-detail-cmd"><strong>input:</strong> ' + esc(ev.input || '') + '</div>'
          + (ev.output ? '<div class="tool-detail-out"><strong>output:</strong>\n' + esc(ev.output) + '</div>' : '')
          + '</div>';
      } else if (t === 'creature.thought') {
        body = cl + '<span class="type thought">thought</span>'
          + '<span class="intent-text"> ' + esc(ev.text || '') + '</span>';
      } else if (t === 'creature.dream') {
        const deep = ev.deep ? ' deep' : '';
        cls += deep;
        const oid = uid();
        const label = ev.deep ? 'deep sleep' : 'dream';
        body = cl + '<span class="type dream' + deep + '">' + label + '</span>'
          + '<span class="tool-ms">' + (ev.observations || 0) + ' observations</span>'
          + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> \u2014 ' + esc(summarize(ev.priority || '', 120)) + '</span>'
          + '<div class="thought-body" id="'+oid+'">'
          + '<strong>Priority:</strong> ' + esc(ev.priority || '') + '\n\n'
          + '<strong>Reflection:</strong>\n' + esc(ev.reflection || '')
          + '</div>';
      } else if (t === 'creature.progress_check') {
        body = cl + '<span class="type progress-check">progress check</span>'
          + '<span class="tool-ms">' + (ev.actions || 0) + ' actions</span>';
      } else if (t === 'creature.error') {
        const retryLabel = ev.retryIn ? 'retry in ' + (ev.retryIn/1000) + 's' : 'recovering';
        body = cl + '<span class="type rollback">error</span>'
          + (ev.retries ? '<span class="retry-badge">attempt #' + ev.retries + '</span>' : '')
          + '<span class="tool-ms">' + retryLabel + '</span>'
          + '<span class="intent-text"> \u2014 ' + esc(ev.error || 'unknown') + '</span>';
      } else if (t === 'creator.evaluation' || t === 'creature.self_evaluation') {
        const oid = uid();
        const changed = ev.changed || (ev.changes || []).length > 0;
        const label = changed ? 'self-evolved' : 'self-evaluated';
        body = cl + '<span class="type creator">' + label + '</span>'
          + (changed ? '<span class="tool-ms">code modified</span>' : '')
          + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> \u2014 ' + esc(summarize(ev.reasoning || '', 120)) + '</span>'
          + '<div class="thought-body" id="'+oid+'">'
          + '<strong>Trigger:</strong> ' + esc(ev.trigger || '') + '\n\n'
          + '<strong>Reasoning:</strong>\n' + esc(ev.reasoning || '')
          + '</div>';
      } else if (t === 'host.promote') {
        body = cl + '<span class="type promote">promoted</span><span class="detail"><span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'host.rollback') {
        body = cl + '<span class="type rollback">rollback</span><span class="detail">' + esc(ev.reason||'') + ' <span class="sha">' + (ev.from||'').slice(0,7) + '</span> \u2192 <span class="sha">' + (ev.to||'').slice(0,7) + '</span></span>';
      } else if (t === 'host.spawn') {
        body = cl + '<span class="type boot">spawn</span><span class="detail">pid ' + (ev.pid||'?') + ' <span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'creature.boot') {
        body = cl + '<span class="type boot">creature boot</span><span class="detail"><span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'host.boot') {
        body = cl + '<span class="type host">host boot</span>';
      } else {
        const label = t.replace(/^creature\./, '').replace(/[._]/g, ' ');
        const fields = Object.keys(ev).filter(k => k !== 't' && k !== 'type' && k !== 'creature');
        if (fields.length) {
          const oid = uid();
          const preview = fields.map(k => {
            const v = ev[k];
            return typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean' ? esc(k + '=' + v) : '';
          }).filter(Boolean).join(', ');
          body = cl + '<span class="type host">' + esc(label) + '</span>'
            + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> \u2014 ' + esc(summarize(preview, 120)) + '</span>'
            + '<div class="thought-body" id="'+oid+'">' + fields.map(k => {
              const v = ev[k];
              const display = typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v);
              return '<strong>' + esc(k) + ':</strong> ' + esc(display);
            }).join('\n') + '</div>';
        } else {
          body = cl + '<span class="type host">' + esc(label) + '</span>';
        }
      }

      return '<div class="event ' + cls + '"><span class="time">' + ts(ev.t) + '</span>' + body + '</div>';
    }

    function isNearBottom() {
      return (window.innerHeight + window.scrollY) >= document.body.scrollHeight - 150;
    }

    // SSE
    const sse = new EventSource('/api/events');
    sse.onmessage = (e) => {
      const ev = JSON.parse(e.data);
      if (selectedTab !== 'log') return;
      if (selected === null) {
        if (ev.type === 'creature.tool_call') return;
      } else if (ev.creature !== selected) return;
      const wasNear = isNearBottom();
      eventsEl.insertAdjacentHTML('beforeend', renderEvent(ev, selected === null));
      if (wasNear) window.scrollTo(0, document.body.scrollHeight);
    };

    function selectTab(tab) {
      selectedTab = tab;
      renderTabs();
      renderContent();
    }

    function renderTabs() {
      if (!selected) { tabBar.classList.remove('visible'); return; }
      tabBar.classList.add('visible');
      const genomeTabs = (mindData && mindData.tabs) || [];
      const tabIds = ['log'].concat(genomeTabs.map(t => t.id));
      const tabLabels = { log: 'log' };
      genomeTabs.forEach(t => { tabLabels[t.id] = t.label || t.id; });
      tabBar.innerHTML = tabIds.map(t =>
        '<div class="tab' + (selectedTab === t ? ' active' : '') + '" onclick="selectTab(\'' + t + '\')">' + (tabLabels[t] || t) + '</div>'
      ).join('') + '<div class="tab-refresh" onclick="loadMind().then(()=>{renderTabs();renderContent();})">\u21bb</div>';
    }

    function renderMarkdown(src) {
      if (!src) return '';
      try { return marked.parse(src); } catch { return esc(src); }
    }

    function renderJsonlEntry(entry) {
      const id = uid();
      const time = entry.t ? timeAgo(entry.t) : '';
      const rest = Object.keys(entry).filter(k => k !== 't');
      const summaryField = rest.find(k => typeof entry[k] === 'string' && entry[k].length > 10) || rest[0];
      const summary = summaryField ? summarize(String(entry[summaryField]), 120) : '...';
      const detail = rest.map(k => {
        const v = entry[k];
        const display = typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v);
        return '<strong>' + esc(k) + ':</strong> ' + esc(display);
      }).join('\n');
      return '<div class="jsonl-entry">'
        + '<span class="jsonl-time">' + time + '</span>'
        + '<span class="jsonl-summary thought-summary" onclick="toggle(\'' + id + '\')" style="cursor:pointer"> ' + esc(summary) + '</span>'
        + '<div class="thought-body" id="' + id + '">' + detail + '</div>'
        + '</div>';
    }

    function renderContent() {
      if (selectedTab === 'log') {
        eventsEl.style.display = '';
        msgBar.classList.toggle('visible', !!selected);
        contentEl.innerHTML = '';
        contentEl.appendChild(eventsEl);
        return;
      }
      msgBar.classList.remove('visible');
      if (!mindData) {
        loadMind().then(() => { renderTabs(); renderContent(); });
        contentEl.innerHTML = '<div class="mind-content">Loading...</div>';
        return;
      }

      const tab = (mindData.tabs || []).find(t => t.id === selectedTab);
      const data = mindData.data && mindData.data[selectedTab];
      let html = '';

      if (!tab) {
        html = 'Unknown tab.';
      } else if (tab.type === 'jsonl') {
        const entries = Array.isArray(data) ? data : [];
        if (entries.length === 0) { html = 'No entries yet.'; }
        else { html = entries.slice().reverse().map(renderJsonlEntry).join(''); }
      } else if (tab.type === 'markdown') {
        html = data ? renderMarkdown(data) : 'Empty.';
      } else {
        html = data ? esc(data) : 'Empty.';
      }

      const preClass = tab && tab.type === 'text' ? ' pre' : '';
      contentEl.innerHTML = '<div class="mind-content' + preClass + '">' + html + '</div>';
    }

    async function select(name) {
      selected = name;
      eventsEl.innerHTML = '';
      mindData = null;
      selectedTab = 'log';
      if (name) {
        headerEl.innerHTML = '<h2>' + esc(name) + '</h2><div class="info" id="cinfo"></div>'
          + '<button class="btn" onclick="wakeC(\'' + name + '\')">wake</button>'
          + '<button class="btn" onclick="restartC(\'' + name + '\')">restart</button>'
          + '<button class="btn" style="color:#f80;border-color:#f80" onclick="rebuildC(\'' + name + '\')">rebuild</button>'
          + '<button class="btn" style="color:#f80;border-color:#f80" onclick="archiveC(\'' + name + '\')">archive</button>';
        try {
          const res = await fetch('/api/creatures/' + name + '/events');
          const events = await res.json();
          for (const ev of events) {
            eventsEl.insertAdjacentHTML('beforeend', renderEvent(ev, false));
          }
          window.scrollTo(0, document.body.scrollHeight);
        } catch {}
        loadMind().then(() => { renderTabs(); });
      } else {
        headerEl.innerHTML = '<h2>all creatures</h2>';
      }
      renderTabs();
      renderContent();
      renderSidebar();
    }

    async function loadMind() {
      if (!selected) return;
      try {
        const res = await fetch('/api/creatures/' + selected + '/files');
        mindData = await res.json();
      } catch { mindData = {}; }
    }

    function fmtCost(usd) { return usd < 0.01 ? '<$0.01' : '$' + usd.toFixed(2); }
    function creatureCost(n) {
      let total = 0;
      for (const [key, val] of Object.entries(usageData)) {
        if (key === n || key.endsWith(':' + n)) total += (val.cost_usd || 0);
      }
      return total;
    }

    function renderSidebar() {
      const names = Object.keys(creatures).sort();
      let html = '<div class="creature-item' + (selected === null ? ' selected' : '') + '" onclick="select(null)">'
        + '<span class="cname" style="color:#888">all</span></div>';
      for (const n of names) {
        const c = creatures[n];
        const sel = selected === n ? ' selected' : '';
        const dot = '<span class="dot ' + c.status + '"></span>';
        const cost = creatureCost(n);
        const costLabel = cost > 0 ? '<span class="creature-cost">' + fmtCost(cost) + '</span>' : '';
        let act = '';
        if (c.status === 'stopped') {
          act = '<button class="btn" onclick="event.stopPropagation();startC(\'' + n + '\')">start</button>';
        } else {
          act = '<button class="btn" onclick="event.stopPropagation();stopC(\'' + n + '\')">stop</button>';
        }
        html += '<div class="creature-item' + sel + '" onclick="select(\'' + n + '\')">'
          + dot + '<span class="cname">' + esc(n) + '</span>' + costLabel + act + '</div>';
      }
      if (totalCost > 0) {
        html += '<div style="padding:12px;border-top:1px solid #222;color:#666;font-size:11px;text-align:right;">total: <span style="color:#f80">' + fmtCost(totalCost) + '</span></div>';
      }
      document.getElementById('creatures').innerHTML = html;
    }

    async function startC(n) { await fetch('/api/creatures/'+n+'/start',{method:'POST'}); refresh(); }
    async function stopC(n) { await fetch('/api/creatures/'+n+'/stop',{method:'POST'}); refresh(); }
    async function restartC(n) { await fetch('/api/creatures/'+n+'/restart',{method:'POST'}); refresh(); }
    async function rebuildC(n) { if(confirm('Rebuild destroys the container environment. Continue?')) { await fetch('/api/creatures/'+n+'/rebuild',{method:'POST'}); refresh(); } }
    async function wakeC(n) { await fetch('/api/creatures/'+n+'/wake',{method:'POST'}); }
    function toggleSpawnForm() {
      document.getElementById('spawnForm').classList.toggle('visible');
      document.getElementById('spawnError').textContent = '';
    }

    async function spawnC() {
      const nameEl = document.getElementById('spawnName');
      const genomeEl = document.getElementById('spawnGenome');
      const modelEl = document.getElementById('spawnModel');
      const purposeEl = document.getElementById('spawnPurpose');
      const errEl = document.getElementById('spawnError');
      const btn = document.getElementById('spawnBtn');
      const name = nameEl.value.trim();
      if (!name) { errEl.textContent = 'name is required'; return; }
      btn.disabled = true;
      btn.textContent = 'spawning...';
      errEl.textContent = '';
      try {
        const body = { name, purpose: purposeEl.value.trim(), genome: genomeEl.value };
        if (modelEl.value) body.model = modelEl.value;
        const res = await fetch('/api/creatures', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) { errEl.textContent = await res.text(); return; }
        nameEl.value = '';
        genomeEl.selectedIndex = 0;
        modelEl.selectedIndex = 0;
        purposeEl.value = '';
        document.getElementById('spawnForm').classList.remove('visible');
        await refresh();
        select(name);
      } catch (e) { errEl.textContent = e.message; }
      finally { btn.disabled = false; btn.textContent = 'spawn'; }
    }

    async function archiveC(n) {
      if (!confirm('Archive creature "' + n + '"? It will be stopped and moved to the archive.')) return;
      await fetch('/api/creatures/' + n + '/archive', { method: 'POST' });
      await refresh();
      select(null);
    }

    async function sendMsg() {
      if (!selected) return;
      const inp = document.getElementById('msg');
      const text = inp.value.trim();
      if (!text) return;
      await fetch('/api/creatures/'+selected+'/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      inp.value = '';
    }

    let usageData = {};
    let totalCost = 0;

    async function refresh() {
      try {
        const [crRes, usRes] = await Promise.all([fetch('/api/creatures'), fetch('/api/usage')]);
        creatures = {};
        for (const c of await crRes.json()) creatures[c.name] = c;
        const ud = await usRes.json();
        usageData = ud.usage || {};
        totalCost = ud.total || 0;
        renderSidebar();
        if (selected && creatures[selected]) {
          const el = document.getElementById('cinfo');
          if (el) {
            const c = creatures[selected];
            el.innerHTML = '<span class="sha">' + (c.sha||'-').slice(0,7) + '</span> \u00b7 ' + c.status;
          }
        }
      } catch {}
    }

    refresh();
    setInterval(refresh, 2000);
  </script>
</body>
</html>
