<!DOCTYPE html>
<html>
<head>
  <title>openseed</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Cdefs%3E%3CradialGradient id='glow'%3E%3Cstop offset='0%25' stop-color='%2322c55e' stop-opacity='0.6'/%3E%3Cstop offset='100%25' stop-color='%2322c55e' stop-opacity='0'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='16' cy='16' r='12' fill='url(%23glow)'/%3E%3Ccircle cx='16' cy='16' r='5' fill='%2322c55e'/%3E%3C/svg%3E">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: #fafafa; color: #1a1a1a; font-size: 13px;
      display: flex;
    }

    .sidebar {
      position: sticky; top: 0; height: 100vh;
      width: 260px; border-right: 1px solid #e5e5e5; background: #fff;
      display: flex; flex-direction: column; flex-shrink: 0;
      overflow-y: auto; transition: width 0.2s, opacity 0.2s;
    }
    .sidebar.hidden { width: 0; opacity: 0; overflow: hidden; border-right: none; }
    .sidebar-header {
      padding: 16px; color: #16a34a; font-size: 16px; font-weight: bold;
      border-bottom: 1px solid #e5e5e5;
      display: flex; align-items: center; justify-content: space-between;
    }
    .sidebar-header .spawn-btn {
      background: none; border: 1px solid #d0d0d0; color: #999;
      width: 22px; height: 22px; border-radius: 3px; cursor: pointer;
      font-size: 16px; line-height: 1; display: flex; align-items: center; justify-content: center;
    }
    .sidebar-header .spawn-btn:hover { color: #16a34a; border-color: #16a34a; }
    .spawn-form {
      display: none; padding: 12px; border-bottom: 1px solid #e5e5e5; background: #f5f5f5;
    }
    .spawn-form.visible { display: flex; flex-direction: column; gap: 8px; }
    .spawn-form input, .spawn-form textarea, .spawn-form select {
      background: #fff; border: 1px solid #d0d0d0; color: #1a1a1a;
      padding: 6px 8px; border-radius: 3px; font-family: inherit; font-size: 12px;
    }
    .spawn-form input:focus, .spawn-form textarea:focus, .spawn-form select:focus { outline: none; border-color: #2563eb; }
    .spawn-form textarea { resize: vertical; min-height: 48px; }
    .spawn-form button {
      background: #f0fdf4; border: 1px solid #16a34a; color: #16a34a;
      padding: 6px 12px; border-radius: 3px; cursor: pointer;
      font-family: inherit; font-size: 12px;
    }
    .spawn-form button:hover { background: #dcfce7; }
    .spawn-form button:disabled { opacity: 0.4; cursor: not-allowed; }
    .spawn-form .spawn-error { color: #dc2626; font-size: 11px; }
    .creature-list { padding: 8px; flex: 1; }
    .creature-item {
      padding: 8px 12px; border-radius: 4px; cursor: pointer;
      display: flex; align-items: center; gap: 8px; margin-bottom: 2px;
    }
    .creature-item:hover { background: #f5f5f5; }
    .creature-item.selected { background: #eff6ff; border-left: 2px solid #2563eb; }
    .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .dot.stopped { background: #999; }
    .dot.starting { background: #d97706; }
    .dot.running { background: #16a34a; }
    .dot.sleeping { background: #d97706; }
    .dot.error { background: #dc2626; animation: pulse-error 1s ease-in-out infinite; }
    @keyframes pulse-error { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    .cname { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .creature-cost { color: #999; font-size: 10px; margin-left: 4px; flex-shrink: 0; }
    .creature-cost.warn { color: #b45309; }
    .creature-cost.over { color: #dc2626; }
    .budget-bar { margin-top: 2px; height: 3px; background: #e5e5e5; border-radius: 2px; overflow: hidden; }
    .budget-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
    .budget-bar-fill.ok { background: #16a34a; }
    .budget-bar-fill.warn { background: #d97706; }
    .budget-bar-fill.over { background: #dc2626; }
    .budget-info {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 4px 10px; background: #fff; border: 1px solid #e5e5e5;
      border-radius: 4px; font-size: 11px; color: #666; cursor: pointer;
    }
    .budget-info:hover { border-color: #d0d0d0; }
    .budget-info .budget-label { color: #999; }
    .budget-info .budget-value { color: #b45309; }
    .budget-info .budget-value.over { color: #dc2626; }
    .budget-info .budget-value.ok { color: #16a34a; }
    .budget-editor {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 4px 10px; background: #fff; border: 1px solid #2563eb;
      border-radius: 4px; font-size: 11px; color: #666;
    }
    .budget-editor input {
      width: 60px; background: #fff; border: 1px solid #d0d0d0;
      color: #b45309; padding: 2px 6px; border-radius: 3px;
      font-family: inherit; font-size: 11px; text-align: right;
    }
    .budget-editor input:focus { outline: none; border-color: #2563eb; }
    .budget-editor select {
      background: #fff; border: 1px solid #d0d0d0; color: #333;
      padding: 2px 4px; border-radius: 3px; font-family: inherit; font-size: 11px;
    }
    .budget-editor select:focus { outline: none; border-color: #2563eb; }
    .budget-editor .be-save {
      background: #f0fdf4; border: 1px solid #16a34a; color: #16a34a;
      padding: 1px 8px; border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 11px;
    }
    .budget-editor .be-save:hover { background: #dcfce7; }
    .budget-editor .be-cancel {
      background: none; border: 1px solid #d0d0d0; color: #999;
      padding: 1px 6px; border-radius: 3px; cursor: pointer; font-family: inherit; font-size: 11px;
    }
    .budget-editor .be-cancel:hover { color: #666; border-color: #999; }
    .sleep-reason { font-size: 10px; color: #dc2626; margin-left: 4px; }
    .btn {
      background: #fff; border: 1px solid #d0d0d0; color: #666;
      padding: 2px 6px; border-radius: 3px; cursor: pointer;
      font-family: inherit; font-size: 11px;
    }
    .btn:hover { background: #f5f5f5; color: #1a1a1a; }

    .main {
      flex: 1; min-width: 0; display: flex; flex-direction: column;
    }
    .main-header {
      position: sticky; top: 0; z-index: 20; background: #fafafa;
      padding: 12px 16px; border-bottom: 1px solid #e5e5e5;
      display: flex; align-items: center; gap: 12px;
    }
    .main-header h2 { color: #1a1a1a; font-size: 14px; margin: 0; }
    .main-header .info { color: #666; font-size: 12px; }
    .main-header .sha { color: #2563eb; }

    .tab-bar {
      position: sticky; top: 44px; z-index: 15; background: #fafafa;
      display: none; border-bottom: 1px solid #e5e5e5;
      padding: 0 16px;
    }
    .tab-bar.visible { display: flex; }
    .tab {
      padding: 8px 16px; cursor: pointer; color: #999;
      font-size: 12px; border-bottom: 2px solid transparent;
    }
    .tab:hover { color: #666; }
    .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
    .tab-refresh {
      margin-left: auto; padding: 8px 12px; cursor: pointer;
      color: #999; font-size: 12px;
    }
    .tab-refresh:hover { color: #666; }

    .content { padding: 16px; flex: 1; }
    .events {
      display: flex; flex-direction: column; gap: 4px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    .event { padding: 7px 12px; border-radius: 4px; border-left: 3px solid #d0d0d0; background: #fff; }
    .event .time { color: #999; font-size: 11px; }
    .event .clabel { color: #2563eb; font-size: 11px; margin-left: 4px; font-weight: bold; }
    .event .type { font-weight: bold; margin-left: 8px; }

    .event.host-boot { border-left-color: #999; }
    .event.host-spawn { border-left-color: #2563eb; }
    .event.host-promote { border-left-color: #16a34a; }
    .event.host-rollback { border-left-color: #dc2626; background: #fef2f2; }
    .event.creature-boot { border-left-color: #2563eb; background: #f8faff; }
    .event.creature-thought { border-left-color: #999; background: #fafafa; }
    .event.creature-sleep { border-left-color: #d97706; background: #fffbf5; }
    .event.creature-wake { border-left-color: #0284c7; background: #f5fbff; }
    .event.creature-message { border-left-color: #2563eb; background: #eff6ff; }
    .event.creature-tool-call { border-left-color: #0284c7; background: #f5fbff; }
    .event.creature-tool-call.browser { border-left-color: #7c3aed; background: #faf5ff; }
    .event.creature-tool-call.fail { border-left-color: #dc2626; background: #fef2f2; }
    .event.creature-dream { border-left-color: #7c3aed; background: #faf5ff; }
    .event.creature-dream.deep { border-left-color: #9333ea; background: #f5f3ff; }
    .event.creature-progress-check { border-left-color: #d97706; background: #fffbf5; }
    .event.creature-error { border-left-color: #dc2626; background: #fef2f2; }
    .event.creature-error .retry-badge { color: #dc2626; font-size: 11px; margin-left: 6px; }
    .event.creator-evaluation { border-left-color: #16a34a; background: #f0fdf4; }
    .event.budget-exceeded { border-left-color: #dc2626; background: #fef2f2; }
    .event.budget-reset { border-left-color: #16a34a; background: #f0fdf4; }

    .event .type.host { color: #999; }
    .event .type.promote { color: #16a34a; }
    .event .type.rollback { color: #dc2626; }
    .event .type.sleep { color: #b45309; }
    .event .type.wake { color: #0284c7; }
    .event .type.message { color: #2563eb; }
    .event .type.tool { color: #0284c7; }
    .event .type.tool.browser { color: #7c3aed; }
    .event .type.tool.fail { color: #dc2626; }
    .event .type.thought { color: #666; }
    .event .type.dream { color: #7c3aed; font-style: italic; }
    .event .type.dream.deep { color: #9333ea; font-weight: bold; }
    .event .type.progress-check { color: #b45309; }
    .event .type.creator { color: #16a34a; font-weight: bold; }
    .event .type.boot { color: #2563eb; }

    .intent-text { color: #333; margin-left: 4px; white-space: pre-wrap; }
    .thought-summary { cursor: pointer; }
    .thought-summary:hover { text-decoration: underline; }
    .thought-body { display: none; margin-top: 6px; padding: 8px; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; word-break: break-word; color: #666; font-size: 12px; }
    .thought-body.open { display: block; }
    .tool-cmd { color: #1a1a1a; background: #f0f0f0; padding: 2px 6px; border-radius: 3px; margin-left: 6px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
    .tool-status { margin-left: 6px; font-size: 11px; }
    .tool-status.ok { color: #16a34a; }
    .tool-status.err { color: #dc2626; }
    .tool-output { display: block; color: #666; margin-top: 4px; padding: 6px 8px; background: #f5f5f5; border-radius: 3px; white-space: pre-wrap; word-break: break-all; font-size: 12px; }
    .tool-ms { color: #999; font-size: 11px; margin-left: 6px; }
    .tool-detail { white-space: pre-wrap; word-break: break-all; font-size: 12px; color: #666; padding: 8px; background: #f5f5f5; border-radius: 4px; margin-top: 6px; }
    .tool-detail-cmd { margin-bottom: 6px; }
    .tool-detail-out { border-top: 1px solid #e5e5e5; padding-top: 6px; }
    .sha { color: #2563eb; }
    .detail { color: #666; margin-left: 4px; }

    .message-bar {
      position: sticky; bottom: 0; background: #fafafa;
      padding: 12px 16px; border-top: 1px solid #e5e5e5;
      display: none; gap: 8px;
    }
    .message-bar.visible { display: flex; }
    .message-bar textarea {
      flex: 1; background: #fff; border: 1px solid #d0d0d0;
      color: #1a1a1a; padding: 8px 12px; border-radius: 4px;
      font-family: inherit; font-size: 13px;
      resize: vertical; min-height: 38px; max-height: 200px;
    }
    .message-bar textarea:focus { outline: none; border-color: #2563eb; }
    .message-bar button {
      background: #eff6ff; border: 1px solid #2563eb; color: #2563eb;
      padding: 8px 16px; border-radius: 4px; cursor: pointer;
      font-family: inherit; font-size: 13px;
    }
    .message-bar button:hover { background: #dbeafe; }

    .mind-content {
      word-break: break-word;
      font-size: 12px; color: #333; line-height: 1.5;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }
    .mind-content.pre { white-space: pre-wrap; }
    .mind-content .jsonl-entry { margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #e5e5e5; }
    .mind-content .jsonl-entry:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
    .mind-content .jsonl-time { color: #999; font-size: 11px; }
    .mind-content .jsonl-summary { color: #333; margin-top: 4px; }
    .mind-content h1 { color: #1a1a1a; font-size: 15px; margin: 16px 0 8px; }
    .mind-content h2 { color: #1a1a1a; font-size: 14px; margin: 14px 0 6px; }
    .mind-content h3 { color: #333; font-size: 13px; margin: 12px 0 4px; }
    .mind-content p { margin: 4px 0; }
    .mind-content li { margin: 2px 0; }
    .mind-content a { color: #2563eb; }
    .mind-content code { background: #f0f0f0; padding: 1px 4px; border-radius: 3px; font-size: 12px; }
    .mind-content pre { background: #f5f5f5; padding: 8px; border-radius: 4px; overflow-x: auto; margin: 8px 0; }
    .mind-content pre code { background: none; padding: 0; }
    .mind-content ul, .mind-content ol { padding-left: 20px; margin: 6px 0; }
    .mind-content blockquote { border-left: 3px solid #d0d0d0; padding-left: 12px; color: #666; margin: 8px 0; }
    .mind-content table { border-collapse: collapse; margin: 8px 0; }
    .mind-content th, .mind-content td { border: 1px solid #e5e5e5; padding: 4px 8px; font-size: 12px; }
    .mind-content th { background: #f5f5f5; color: #1a1a1a; }

    .overview { padding: 20px 32px; max-width: 800px; margin: 0 auto; }
    .status-strip {
      display: flex; flex-wrap: wrap; gap: 4px 14px;
      padding-bottom: 20px; margin-bottom: 20px;
      border-bottom: 1px solid #e5e5e5; font-size: 12px;
    }
    .strip-item {
      display: inline-flex; align-items: center; gap: 6px;
      cursor: pointer; color: #999; transition: color 0.15s;
    }
    .strip-item:hover { color: #333; }
    .strip-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .strip-dot.running { background: #16a34a; }
    .strip-dot.sleeping { background: #d97706; }
    .strip-dot.stopped { background: #999; }
    .strip-dot.error { background: #dc2626; }
    .strip-dot.starting { background: #d97706; }

    .moments { display: flex; flex-direction: column; gap: 6px; }
    .moment {
      padding: 14px 18px; border-radius: 6px;
      border-left: 3px solid #d0d0d0; background: #fff;
      animation: moment-in 0.3s ease-out;
    }
    @keyframes moment-in { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
    .moment-dream { border-left-color: #7c3aed; }
    .moment-deep-dream { border-left-color: #9333ea; }
    .moment-sleep { border-left-color: #d97706; }
    .moment-evolved { border-left-color: #16a34a; }
    .moment-eval { border-left-color: #16a34a; }
    .moment-thought { border-left-color: #999; }
    .moment-wake { border-left-color: #0284c7; }
    .moment-budget { border-left-color: #dc2626; }
    .moment-budget-ok { border-left-color: #16a34a; }
    .moment-header {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 8px; font-size: 12px;
    }
    .moment-creature { color: #1a1a1a; font-weight: bold; cursor: pointer; }
    .moment-creature:hover { text-decoration: underline; }
    .moment-label { font-size: 11px; }
    .moment-label.dream { color: #7c3aed; }
    .moment-label.deep { color: #9333ea; font-weight: bold; }
    .moment-label.sleep { color: #b45309; }
    .moment-label.evolved { color: #16a34a; }
    .moment-label.eval { color: #16a34a; }
    .moment-label.thought { color: #999; }
    .moment-label.wake { color: #0284c7; }
    .moment-label.budget { color: #dc2626; }
    .moment-label.budget-ok { color: #16a34a; }
    .moment-time { color: #999; margin-left: auto; font-size: 11px; }
    .moment-text {
      color: #333; font-size: 13px; line-height: 1.6;
      white-space: pre-wrap; word-break: break-word;
    }
    .moment-reflection {
      color: #666; font-size: 12px; font-style: italic;
      line-height: 1.5; margin-top: 8px;
      border-left: 2px solid #e5e5e5; padding-left: 12px;
    }
    .moment-meta { color: #999; font-size: 11px; margin-top: 6px; }

    .narration-feed { display: flex; flex-direction: column; gap: 12px; }
    .narration-entry {
      padding: 16px 20px; border-radius: 6px;
      border-left: 3px solid #16a34a; background: #fff;
      animation: moment-in 0.3s ease-out;
    }
    .narration-header {
      display: flex; align-items: center; gap: 8px;
      margin-bottom: 10px; font-size: 11px; color: #999;
    }
    .narration-label { color: #16a34a; font-weight: bold; font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase; }
    .narration-time { margin-left: auto; }
    .narration-text {
      color: #333; font-size: 15px; line-height: 1.75;
      font-family: 'Georgia', 'Times New Roman', serif;
      word-break: break-word;
    }
    .narration-text p { margin: 0 0 10px; }
    .narration-text p:last-child { margin-bottom: 0; }
    .narration-text strong { color: #1a1a1a; }
    .narration-text em { color: #666; }
    .narration-text code { background: #f0f0f0; padding: 1px 4px; border-radius: 3px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12px; }
    .narration-creatures { margin-top: 8px; font-size: 10px; color: #999; }
    .narration-creatures span { color: #16a34a; cursor: pointer; }
    .narration-creatures span:hover { text-decoration: underline; }

    .moments-toggle {
      margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e5e5;
    }
    .moments-toggle-btn {
      background: none; border: 1px solid #d0d0d0; color: #999;
      padding: 4px 12px; border-radius: 3px; cursor: pointer;
      font-family: inherit; font-size: 11px;
    }
    .moments-toggle-btn:hover { color: #666; border-color: #999; }
    .moments-toggle-btn.active { color: #666; border-color: #999; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <span>openseed</span>
      <button class="spawn-btn" onclick="toggleSpawnForm()" title="Spawn new creature">+</button>
    </div>
    <div class="spawn-form" id="spawnForm">
      <input id="spawnName" placeholder="name (lowercase)" maxlength="32" />
      <select id="spawnGenome"></select>
      <select id="spawnModel">
        <option value="">model (default: opus)</option>
        <option value="claude-opus-4-6">claude-opus-4-6 ($5/$25)</option>
        <option value="claude-sonnet-4-5">claude-sonnet-4-5 ($3/$15)</option>
        <option value="claude-haiku-4-5">claude-haiku-4-5 ($1/$5)</option>
        <option value="gpt-5.2">gpt-5.2 ($1.75/$14)</option>
        <option value="gpt-5-mini">gpt-5-mini ($0.25/$2)</option>
        <option value="o4-mini">o4-mini ($1.10/$4.40)</option>
      </select>
      <textarea id="spawnPurpose" placeholder="purpose (optional)" rows="3"></textarea>
      <button id="spawnBtn" onclick="spawnC()">spawn</button>
      <div class="spawn-error" id="spawnError"></div>
    </div>
    <div class="creature-list" id="creatures"></div>
    <div id="sidebarFooter" style="border-top:1px solid #e5e5e5;padding:12px;font-size:11px;flex-shrink:0;">
      <div id="totalCostDisplay"></div>
      <div id="globalBudget" style="color:#999;"></div>
    </div>
  </div>
  <div class="main">
    <div class="main-header" id="header">
      <h2>all creatures</h2>
    </div>
    <div class="tab-bar" id="tabbar"></div>
    <div class="content" id="content">
      <div class="events" id="events"></div>
    </div>
    <div class="message-bar" id="msgbar">
      <textarea id="msg" placeholder="Message to creature... (Cmd+Enter to send)" rows="2" onkeydown="if(event.key==='Enter'&&event.metaKey){event.preventDefault();sendMsg()}"></textarea>
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script>
    let selected = null;
    let creatures = {};
    let selectedTab = 'log';
    let mindData = null;
    let lastIntentMap = {};
    let showMoments = false;
    const eventsEl = document.getElementById('events');
    const headerEl = document.getElementById('header');
    const tabBar = document.getElementById('tabbar');
    const contentEl = document.getElementById('content');
    const msgBar = document.getElementById('msgbar');

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function ts(t) { return t ? t.slice(11, 19) : ''; }
    function toggle(id) { document.getElementById(id)?.classList.toggle('open'); }
    function summarize(text, max) {
      if (!text) return '...';
      const line = text.split('\n').map(l => l.trim()).filter(l => l && !l.startsWith('#'))[0] || text.trim();
      return line.length > max ? line.slice(0, max) + '...' : line;
    }

    function timeAgo(iso) {
      if (!iso) return '';
      const now = Date.now(), then = new Date(iso).getTime();
      const s = Math.floor((now - then) / 1000);
      if (s < 60) return 'just now';
      if (s < 3600) return Math.floor(s/60) + 'm ago';
      if (s < 86400) return Math.floor(s/3600) + 'h ago';
      if (s < 172800) return 'yesterday';
      return Math.floor(s/86400) + 'd ago';
    }

    function uid() { return 'u' + Date.now() + Math.random().toString(36).slice(2,6); }

    function renderEvent(ev, showCreature) {
      const t = ev.type;
      let cls = t.replace(/\./g, '-');
      let body = '';
      const cl = showCreature && ev.creature ? '<span class="clabel">' + esc(ev.creature) + '</span>' : '';

      if (t === 'creature.sleep') {
        const secs = ev.seconds || 30;
        const acts = ev.actions || 0;
        const id = uid();
        body = cl + '<span class="type sleep">sleep</span>'
          + '<span class="tool-ms">' + secs + 's / ' + acts + ' actions</span>'
          + '<span class="intent-text thought-summary" onclick="toggle(\''+id+'\')"> - ' + esc(summarize(ev.text, 120)) + '</span>'
          + '<div class="thought-body" id="'+id+'">' + esc(ev.text || '') + '</div>';
      } else if (t === 'creature.wake') {
        body = cl + '<span class="type wake">wake</span>'
          + '<span class="tool-ms">' + esc(ev.source || '') + '</span>'
          + '<span class="detail"> - ' + esc(ev.reason || '') + '</span>';
      } else if (t === 'creature.message') {
        body = cl + '<span class="type message">' + esc(ev.source || 'user') + '</span>'
          + '<span class="intent-text"> ' + esc(ev.text || '') + '</span>';
      } else if (t === 'creature.tool_call') {
        const tn = ev.tool || 'bash';
        const br = tn === 'browser';
        cls += ev.ok ? '' : ' fail';
        cls += br ? ' browser' : '';
        const tc = 'type tool' + (br ? ' browser' : '') + (ev.ok ? '' : ' fail');
        const oid = uid();
        const cmdPreview = (ev.input || '').length > 80 ? (ev.input || '').slice(0,80) + '...' : (ev.input || '');
        body = cl + '<span class="' + tc + ' thought-summary" onclick="toggle(\''+oid+'\')">\u25b6 ' + esc(tn) + '</span>'
          + '<code class="tool-cmd thought-summary" onclick="toggle(\''+oid+'\')"> ' + esc(cmdPreview) + '</code>'
          + (ev.ok ? '<span class="tool-status ok">ok</span>' : '<span class="tool-status err">fail</span>')
          + '<span class="tool-ms">' + (ev.ms||0) + 'ms</span>'
          + '<div class="tool-detail thought-body" id="'+oid+'">'
          + '<div class="tool-detail-cmd"><strong>input:</strong> ' + esc(ev.input || '') + '</div>'
          + (ev.output ? '<div class="tool-detail-out"><strong>output:</strong>\n' + esc(ev.output) + '</div>' : '')
          + '</div>';
      } else if (t === 'creature.thought') {
        body = cl + '<span class="type thought">thought</span>'
          + '<span class="intent-text"> ' + esc(ev.text || '') + '</span>';
      } else if (t === 'creature.dream') {
        const deep = ev.deep ? ' deep' : '';
        cls += deep;
        const oid = uid();
        const label = ev.deep ? 'deep sleep' : 'dream';
        body = cl + '<span class="type dream' + deep + '">' + label + '</span>'
          + '<span class="tool-ms">' + (ev.observations || 0) + ' observations</span>'
          + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> - ' + esc(summarize(ev.priority || '', 120)) + '</span>'
          + '<div class="thought-body" id="'+oid+'">'
          + '<strong>Priority:</strong> ' + esc(ev.priority || '') + '\n\n'
          + '<strong>Reflection:</strong>\n' + esc(ev.reflection || '')
          + '</div>';
      } else if (t === 'creature.progress_check') {
        body = cl + '<span class="type progress-check">progress check</span>'
          + '<span class="tool-ms">' + (ev.actions || 0) + ' actions</span>';
      } else if (t === 'creature.error') {
        const retryLabel = ev.retryIn ? 'retry in ' + (ev.retryIn/1000) + 's' : 'recovering';
        body = cl + '<span class="type rollback">error</span>'
          + (ev.retries ? '<span class="retry-badge">attempt #' + ev.retries + '</span>' : '')
          + '<span class="tool-ms">' + retryLabel + '</span>'
          + '<span class="intent-text"> - ' + esc(ev.error || 'unknown') + '</span>';
      } else if (t === 'creator.evaluation' || t === 'creature.self_evaluation') {
        const oid = uid();
        const changed = ev.changed || (ev.changes || []).length > 0;
        const label = changed ? 'self-evolved' : 'self-evaluated';
        body = cl + '<span class="type creator">' + label + '</span>'
          + (changed ? '<span class="tool-ms">code modified</span>' : '')
          + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> - ' + esc(summarize(ev.reasoning || '', 120)) + '</span>'
          + '<div class="thought-body" id="'+oid+'">'
          + '<strong>Trigger:</strong> ' + esc(ev.trigger || '') + '\n\n'
          + '<strong>Reasoning:</strong>\n' + esc(ev.reasoning || '')
          + '</div>';
      } else if (t === 'host.promote') {
        body = cl + '<span class="type promote">promoted</span><span class="detail"><span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'host.rollback') {
        body = cl + '<span class="type rollback">rollback</span><span class="detail">' + esc(ev.reason||'') + ' <span class="sha">' + (ev.from||'').slice(0,7) + '</span> \u2192 <span class="sha">' + (ev.to||'').slice(0,7) + '</span></span>';
      } else if (t === 'budget.exceeded') {
        body = cl + '<span class="type rollback">budget exceeded</span>'
          + '<span class="detail">$' + ((ev.daily_spent||0).toFixed(2)) + ' / $' + ((ev.daily_cap||0).toFixed(2)) + ' daily cap</span>';
      } else if (t === 'budget.reset') {
        body = cl + '<span class="type promote">budget reset</span>'
          + '<span class="detail">daily budget renewed</span>';
      } else if (t === 'host.spawn') {
        body = cl + '<span class="type boot">spawn</span><span class="detail">pid ' + (ev.pid||'?') + ' <span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'creature.boot') {
        body = cl + '<span class="type boot">creature boot</span><span class="detail"><span class="sha">' + (ev.sha||'').slice(0,7) + '</span></span>';
      } else if (t === 'host.boot') {
        body = cl + '<span class="type host">host boot</span>';
      } else {
        const label = t.replace(/^creature\./, '').replace(/[._]/g, ' ');
        const fields = Object.keys(ev).filter(k => k !== 't' && k !== 'type' && k !== 'creature');
        if (fields.length) {
          const oid = uid();
          const preview = fields.map(k => {
            const v = ev[k];
            return typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean' ? esc(k + '=' + v) : '';
          }).filter(Boolean).join(', ');
          body = cl + '<span class="type host">' + esc(label) + '</span>'
            + '<span class="intent-text thought-summary" onclick="toggle(\''+oid+'\')"> - ' + esc(summarize(preview, 120)) + '</span>'
            + '<div class="thought-body" id="'+oid+'">' + fields.map(k => {
              const v = ev[k];
              const display = typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v);
              return '<strong>' + esc(k) + ':</strong> ' + esc(display);
            }).join('\n') + '</div>';
        } else {
          body = cl + '<span class="type host">' + esc(label) + '</span>';
        }
      }

      return '<div class="event ' + cls + '"><span class="time">' + ts(ev.t) + '</span>' + body + '</div>';
    }

    function isNearBottom() {
      return (window.innerHeight + window.scrollY) >= document.body.scrollHeight - 150;
    }

    // SSE
    const sse = new EventSource('/api/events');
    sse.onmessage = (e) => {
      const ev = JSON.parse(e.data);

      if (ev.creature) {
        if (ev.type === 'creature.sleep' && ev.text) {
          lastIntentMap[ev.creature] = ev.text.length > 100 ? ev.text.slice(0, 100) + '...' : ev.text;
        } else if (ev.type === 'creature.thought' && ev.text) {
          lastIntentMap[ev.creature] = ev.text.length > 100 ? ev.text.slice(0, 100) + '...' : ev.text;
        } else if (ev.type === 'creature.dream') {
          lastIntentMap[ev.creature] = (ev.deep ? 'deep sleep: ' : 'dreaming: ') + (ev.priority || '').slice(0, 80);
        } else if (ev.type === 'creature.tool_call') {
          const cmd = (ev.input || '').split('\n')[0];
          lastIntentMap[ev.creature] = '\u25b6 ' + (cmd.length > 80 ? cmd.slice(0, 80) + '...' : cmd);
        }
      }

      

      if (selected === null) {
        if (ev.type === 'narrator.entry') {
          const entry = { t: ev.t, text: ev.text, creatures_mentioned: ev.creatures_mentioned || [] };
          const html = renderNarrationEntry(entry);
          const feed = document.getElementById('narrationFeed');
          if (feed) {
            const placeholder = feed.querySelector('div[style*="text-align:center"]');
            if (placeholder) placeholder.remove();
            feed.insertAdjacentHTML('afterbegin', html);
            while (feed.children.length > 10) feed.lastChild.remove();
          }
          return;
        }
        if (isInterestingEvent(ev)) {
          const momentHtml = renderMoment(ev);
          if (momentHtml) {
            const feed = document.getElementById('momentsFeed');
            if (feed) {
              const placeholder = feed.querySelector('div[style*="text-align:center"]');
              if (placeholder) placeholder.remove();
              feed.insertAdjacentHTML('afterbegin', momentHtml);
              while (feed.children.length > 60) feed.lastChild.remove();
            }
            if (!showMoments) {
              const btn = contentEl.querySelector('.moments-toggle-btn');
              const count = document.getElementById('momentsFeed')?.children.length || 0;
              if (btn) btn.textContent = '\u25b6 show raw events (' + count + ')';
            }
          }
        }
        return;
      }

      if (selectedTab !== 'log') return;
      if (ev.creature !== selected) return;
      const wasNear = isNearBottom();
      eventsEl.insertAdjacentHTML('beforeend', renderEvent(ev, false));
      if (wasNear) window.scrollTo(0, document.body.scrollHeight);
    };

    function selectTab(tab) {
      selectedTab = tab;
      renderTabs();
      renderContent();
    }

    function renderTabs() {
      if (!selected) { tabBar.classList.remove('visible'); return; }
      tabBar.classList.add('visible');
      const genomeTabs = (mindData && mindData.tabs) || [];
      const tabIds = ['log'].concat(genomeTabs.map(t => t.id));
      const tabLabels = { log: 'log' };
      genomeTabs.forEach(t => { tabLabels[t.id] = t.label || t.id; });
      tabBar.innerHTML = tabIds.map(t =>
        '<div class="tab' + (selectedTab === t ? ' active' : '') + '" onclick="selectTab(\'' + t + '\')">' + (tabLabels[t] || t) + '</div>'
      ).join('') + '<div class="tab-refresh" onclick="loadMind().then(()=>{renderTabs();renderContent();})">\u21bb</div>';
    }

    function renderMarkdown(src) {
      if (!src) return '';
      try { return marked.parse(src); } catch { return esc(src); }
    }

    function renderJsonlEntry(entry) {
      const id = uid();
      const time = entry.t ? timeAgo(entry.t) : '';
      const rest = Object.keys(entry).filter(k => k !== 't');
      const summaryField = rest.find(k => typeof entry[k] === 'string' && entry[k].length > 10) || rest[0];
      const summary = summaryField ? summarize(String(entry[summaryField]), 120) : '...';
      const detail = rest.map(k => {
        const v = entry[k];
        const display = typeof v === 'object' ? JSON.stringify(v, null, 2) : String(v);
        return '<strong>' + esc(k) + ':</strong> ' + esc(display);
      }).join('\n');
      return '<div class="jsonl-entry">'
        + '<span class="jsonl-time">' + time + '</span>'
        + '<span class="jsonl-summary thought-summary" onclick="toggle(\'' + id + '\')" style="cursor:pointer"> ' + esc(summary) + '</span>'
        + '<div class="thought-body" id="' + id + '">' + detail + '</div>'
        + '</div>';
    }

    function renderContent() {
      if (selectedTab === 'log') {
        if (selected === null) {
          renderOverview();
          msgBar.classList.remove('visible');
          return;
        }
        eventsEl.style.display = '';
        msgBar.classList.add('visible');
        contentEl.innerHTML = '';
        contentEl.appendChild(eventsEl);
        requestAnimationFrame(() => window.scrollTo(0, document.body.scrollHeight));
        return;
      }
      msgBar.classList.remove('visible');
      if (!mindData) {
        loadMind().then(() => { renderTabs(); renderContent(); });
        contentEl.innerHTML = '<div class="mind-content">Loading...</div>';
        return;
      }

      const tab = (mindData.tabs || []).find(t => t.id === selectedTab);
      const data = mindData.data && mindData.data[selectedTab];
      let html = '';

      if (!tab) {
        html = 'Unknown tab.';
      } else if (tab.type === 'jsonl') {
        const entries = Array.isArray(data) ? data : [];
        if (entries.length === 0) { html = 'No entries yet.'; }
        else { html = entries.slice().reverse().map(renderJsonlEntry).join(''); }
      } else if (tab.type === 'markdown') {
        html = data ? renderMarkdown(data) : 'Empty.';
      } else {
        html = data ? esc(data) : 'Empty.';
      }

      const preClass = tab && tab.type === 'text' ? ' pre' : '';
      contentEl.innerHTML = '<div class="mind-content' + preClass + '">' + html + '</div>';
    }

    async function select(name) {
      selected = name;
      eventsEl.innerHTML = '';
      mindData = null;
      selectedTab = 'log';
      document.querySelector('.sidebar').classList.toggle('hidden', !name);
      if (name) {
        headerEl.innerHTML = '<h2>' + esc(name) + '</h2><div class="info" id="cinfo"></div>'
          + '<div class="budget-info" id="budgetInfo"></div>'
          + '<button class="btn" onclick="wakeC(\'' + name + '\')">wake</button>'
          + '<button class="btn" onclick="restartC(\'' + name + '\')">restart</button>'
          + '<button class="btn" style="color:#b45309;border-color:#d97706" onclick="rebuildC(\'' + name + '\')">rebuild</button>'
          + '<button class="btn" style="color:#b45309;border-color:#d97706" onclick="archiveC(\'' + name + '\')">archive</button>';
        try {
          const [evRes, budgetRes] = await Promise.all([
            fetch('/api/creatures/' + name + '/events'),
            fetch('/api/creatures/' + name + '/budget'),
          ]);
          const events = await evRes.json();
          for (const ev of events) {
            eventsEl.insertAdjacentHTML('beforeend', renderEvent(ev, false));
          }
          window.scrollTo(0, document.body.scrollHeight);
          const budget = await budgetRes.json();
          renderBudgetInfo(budget);
        } catch {}
        loadMind().then(() => { renderTabs(); });
      }
      renderTabs();
      renderContent();
      renderSidebar();
    }

    let lastBudget = null;

    function renderBudgetInfo(budget) {
      const el = document.getElementById('budgetInfo');
      if (!el || !budget) return;
      lastBudget = budget;
      el.className = 'budget-info';
      el.onclick = () => openBudgetEditor();
      if (budget.action === 'off') {
        el.innerHTML = '<span class="budget-label">cap off</span><span style="color:#999">click to edit</span>';
        return;
      }
      const pct = budget.daily_cap_usd > 0 ? Math.min(100, (budget.daily_spent_usd / budget.daily_cap_usd) * 100) : 0;
      const cls = budget.status === 'exceeded' ? 'over' : pct >= 80 ? 'warn' : 'ok';
      el.innerHTML = '<span class="budget-label">today</span>'
        + '<span class="budget-value ' + cls + '">' + fmtCost(budget.daily_spent_usd) + '</span>'
        + '<span class="budget-label">/ ' + fmtCost(budget.daily_cap_usd) + '</span>'
        + '<div class="budget-bar" style="width:60px"><div class="budget-bar-fill ' + cls + '" style="width:' + pct + '%"></div></div>'
        + (budget.status === 'exceeded' ? '<span class="budget-value over">exceeded</span>' : '');
    }

    function openBudgetEditor() {
      const el = document.getElementById('budgetInfo');
      if (!el || !selected) return;
      const cap = lastBudget ? lastBudget.daily_cap_usd : 20;
      const action = lastBudget ? lastBudget.action : 'sleep';
      el.className = 'budget-editor';
      el.onclick = null;
      el.innerHTML = '<span class="budget-label">daily $</span>'
        + '<input id="beCap" type="number" min="0" step="1" value="' + cap + '" />'
        + '<select id="beAction">'
        + '<option value="sleep"' + (action==='sleep'?' selected':'') + '>sleep when exceeded</option>'
        + '<option value="warn"' + (action==='warn'?' selected':'') + '>warn only</option>'
        + '<option value="off"' + (action==='off'?' selected':'') + '>no cap</option>'
        + '</select>'
        + '<button class="be-save" onclick="saveBudget()">save</button>'
        + '<button class="be-cancel" onclick="cancelBudgetEdit()">cancel</button>';
      document.getElementById('beCap').focus();
      document.getElementById('beCap').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveBudget();
        if (e.key === 'Escape') cancelBudgetEdit();
      });
    }

    async function saveBudget() {
      if (!selected) return;
      const capVal = parseFloat(document.getElementById('beCap').value);
      const actionVal = document.getElementById('beAction').value;
      try {
        await fetch('/api/creatures/' + selected + '/budget', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ daily_usd: capVal, action: actionVal }),
        });
        const res = await fetch('/api/creatures/' + selected + '/budget');
        renderBudgetInfo(await res.json());
      } catch (e) { cancelBudgetEdit(); }
    }

    function cancelBudgetEdit() {
      if (lastBudget) renderBudgetInfo(lastBudget);
    }

    let globalBudgetData = null;

    async function loadGlobalBudget() {
      try {
        const res = await fetch('/api/budget');
        globalBudgetData = await res.json();
      } catch {}
    }

    function renderGlobalBudget() {
      const el = document.getElementById('globalBudget');
      if (!el || !globalBudgetData) return;
      const b = globalBudgetData;
      const label = b.action === 'off' ? 'no cap' : '$' + b.daily_usd + '/day \u00b7 ' + b.action;
      el.innerHTML = '<span style="color:#999">global cap:</span> '
        + '<span style="color:#b45309;cursor:pointer" onclick="openGlobalBudgetEditor()" title="click to edit">' + esc(label) + ' \u270e</span>';
    }

    function openGlobalBudgetEditor() {
      const el = document.getElementById('globalBudget');
      if (!el) return;
      const cap = globalBudgetData ? globalBudgetData.daily_usd : 20;
      const action = globalBudgetData ? globalBudgetData.action : 'sleep';
      el.innerHTML = '<div class="budget-editor" style="display:flex;flex-wrap:wrap;margin:0;gap:4px;">'
        + '<span class="budget-label" style="font-size:10px;">$/day</span>'
        + '<input id="gbCap" type="number" min="0" step="1" value="' + cap + '" style="width:50px;" />'
        + '<select id="gbAction">'
        + '<option value="sleep"' + (action==='sleep'?' selected':'') + '>sleep</option>'
        + '<option value="warn"' + (action==='warn'?' selected':'') + '>warn</option>'
        + '<option value="off"' + (action==='off'?' selected':'') + '>off</option>'
        + '</select>'
        + '<button class="be-save" onclick="saveGlobalBudget()">save</button>'
        + '<button class="be-cancel" onclick="renderGlobalBudget()">x</button>'
        + '</div>';
      const inp = document.getElementById('gbCap');
      inp.focus();
      inp.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') saveGlobalBudget();
        if (e.key === 'Escape') renderGlobalBudget();
      });
    }

    async function saveGlobalBudget() {
      const capVal = parseFloat(document.getElementById('gbCap').value);
      const actionVal = document.getElementById('gbAction').value;
      try {
        await fetch('/api/budget', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ daily_usd: capVal, action: actionVal }),
        });
        await loadGlobalBudget();
        renderGlobalBudget();
      } catch { renderGlobalBudget(); }
    }

    async function loadMind() {
      if (!selected) return;
      try {
        const res = await fetch('/api/creatures/' + selected + '/files');
        mindData = await res.json();
      } catch { mindData = {}; }
    }

    function fmtCost(usd) { return usd < 0.01 ? '<$0.01' : '$' + usd.toFixed(2); }
    function creatureCost(n) {
      let total = 0;
      for (const [key, val] of Object.entries(usageData)) {
        if (key === n || key.endsWith(':' + n)) total += (val.cost_usd || 0);
      }
      return total;
    }
    function creatureDailyCost(n) {
      const today = new Date().toISOString().slice(0, 10);
      for (const [key, val] of Object.entries(usageData)) {
        if ((key === n || key.endsWith(':' + n)) && val.daily_date === today) {
          return val.daily_cost_usd || 0;
        }
      }
      return 0;
    }

    function renderSidebar() {
      const names = Object.keys(creatures).sort();
      let html = '<div class="creature-item' + (selected === null ? ' selected' : '') + '" onclick="select(null)">'
        + '<span class="cname" style="color:#999">overview</span></div>';
      for (const n of names) {
        const c = creatures[n];
        const sel = selected === n ? ' selected' : '';
        const dot = '<span class="dot ' + c.status + '"></span>';
        const b = creatureBudgets[n];
        let costLabel = '';
        if (b && b.action !== 'off' && b.daily_cap_usd > 0) {
          const pct = Math.min(100, Math.round((b.daily_spent_usd / b.daily_cap_usd) * 100));
          const cls = pct >= 100 ? 'creature-cost over' : pct >= 80 ? 'creature-cost warn' : 'creature-cost';
          costLabel = '<span class="' + cls + '">' + pct + '%</span>';
        }
        const budgetLabel = c.sleepReason === 'budget' ? '<span class="sleep-reason">capped</span>' : '';
        let act = '';
        if (c.status === 'stopped' || c.sleepReason === 'budget') {
          act = '<button class="btn" onclick="event.stopPropagation();startC(\'' + n + '\')">start</button>';
        } else {
          act = '<button class="btn" onclick="event.stopPropagation();stopC(\'' + n + '\')">stop</button>';
        }
        html += '<div class="creature-item' + sel + '" onclick="select(\'' + n + '\')">'
          + dot + '<span class="cname">' + esc(n) + '</span>' + budgetLabel + costLabel + act + '</div>';
      }
      document.getElementById('creatures').innerHTML = html;
      const tcd = document.getElementById('totalCostDisplay');
      if (tcd) tcd.innerHTML = '';
      if (!document.getElementById('gbCap')) renderGlobalBudget();
    }

    function isInterestingEvent(ev) {
      const t = ev.type;
      if (t === 'creature.dream') return true;
      if (t === 'creature.sleep' && ev.text) return true;
      if (t === 'creature.self_evaluation' || t === 'creator.evaluation') return true;
      if (t === 'creature.thought' && ev.text && ev.text.length > 20) return true;
      if (t === 'creature.wake') return true;
      if (t === 'budget.exceeded' || t === 'budget.reset') return true;
      return false;
    }

    function renderMoment(ev) {
      const t = ev.type;
      let cls = '', label = '', lcls = '', content = '';

      if (t === 'creature.dream') {
        cls = ev.deep ? 'moment-deep-dream' : 'moment-dream';
        label = ev.deep ? 'deep sleep' : 'dream';
        lcls = ev.deep ? 'deep' : 'dream';
        if (ev.priority) content += '<div class="moment-text">' + esc(ev.priority) + '</div>';
        if (ev.reflection) content += '<div class="moment-reflection">' + esc(ev.reflection.length > 400 ? ev.reflection.slice(0, 400) + '...' : ev.reflection) + '</div>';
        if (ev.observations) content += '<div class="moment-meta">' + ev.observations + ' observations consolidated</div>';
      } else if (t === 'creature.sleep') {
        cls = 'moment-sleep'; label = 'sleeping'; lcls = 'sleep';
        const secs = ev.seconds || 0;
        const dur = secs >= 3600 ? Math.round(secs / 3600) + 'h' : Math.round(secs / 60) + 'm';
        content = '<div class="moment-text">' + esc(ev.text || '') + '</div>';
        content += '<div class="moment-meta">' + (ev.actions || 0) + ' actions this cycle' + (secs ? ' \u00b7 sleeping ' + dur : '') + '</div>';
      } else if (t === 'creature.self_evaluation' || t === 'creator.evaluation') {
        const changed = ev.changed || (ev.changes || []).length > 0;
        cls = changed ? 'moment-evolved' : 'moment-eval';
        label = changed ? 'self-evolved' : 'self-evaluated';
        lcls = changed ? 'evolved' : 'eval';
        content = '<div class="moment-text">' + esc((ev.reasoning || '').slice(0, 400)) + '</div>';
      } else if (t === 'creature.thought') {
        cls = 'moment-thought'; label = 'thought'; lcls = 'thought';
        content = '<div class="moment-text">' + esc(ev.text || '') + '</div>';
      } else if (t === 'creature.wake') {
        cls = 'moment-wake'; label = 'woke'; lcls = 'wake';
        content = '<div class="moment-meta">' + esc(ev.reason || ev.source || '') + '</div>';
      } else if (t === 'budget.exceeded') {
        cls = 'moment-budget'; label = 'budget exceeded'; lcls = 'budget';
        content = '<div class="moment-meta">$' + (ev.daily_spent || 0).toFixed(2) + ' / $' + (ev.daily_cap || 0).toFixed(2) + ' daily cap</div>';
      } else if (t === 'budget.reset') {
        cls = 'moment-budget-ok'; label = 'budget reset'; lcls = 'budget-ok';
      } else { return ''; }

      const c = creatures[ev.creature];
      const dotCls = c ? c.status : 'stopped';
      return '<div class="moment ' + cls + '">'
        + '<div class="moment-header">'
        + '<span class="strip-dot ' + dotCls + '"></span>'
        + '<span class="moment-creature" onclick="select(\'' + esc(ev.creature || '') + '\')">' + esc(ev.creature || '') + '</span>'
        + '<span class="moment-label ' + lcls + '">' + label + '</span>'
        + '<span class="moment-time">' + timeAgo(ev.t) + '</span>'
        + '</div>' + content + '</div>';
    }

    let allMoments = [];
    let narrationEntries = [];

    async function loadNarration() {
      try {
        const res = await fetch('/api/narration?limit=10');
        narrationEntries = await res.json();
        narrationEntries.reverse();
      } catch { narrationEntries = []; }
    }

    function renderNarrationEntry(entry) {
      const html = renderMarkdown(entry.text);
      const mentioned = (entry.creatures_mentioned || []).map(
        n => '<span onclick="select(\'' + esc(n) + '\')">' + esc(n) + '</span>'
      ).join(', ');
      return '<div class="narration-entry">'
        + '<div class="narration-header">'
        + '<span class="narration-label">narrator</span>'
        + '<span class="narration-time">' + timeAgo(entry.t) + '</span>'
        + '</div>'
        + '<div class="narration-text">' + html + '</div>'
        + (mentioned ? '<div class="narration-creatures">' + mentioned + '</div>' : '')
        + '</div>';
    }

    async function loadRecentEvents() {
      const names = Object.keys(creatures);
      try {
        const results = await Promise.all(
          names.map(n => fetch('/api/creatures/' + n + '/events').then(r => r.json()).catch(() => []))
        );
        allMoments = [];
        results.forEach((events, i) => {
          events.slice(-30).forEach(ev => {
            ev.creature = ev.creature || names[i];
            if (isInterestingEvent(ev)) allMoments.push(ev);
          });
        });
        allMoments.sort((a, b) => (b.t || '').localeCompare(a.t || ''));
        allMoments = allMoments.slice(0, 60);
      } catch {}
    }

    function renderOverview() {
      document.querySelector('.sidebar').classList.add('hidden');
      const names = Object.keys(creatures).sort();

      let strip = '';
      for (const n of names) {
        const c = creatures[n];
        strip += '<span class="strip-item" onclick="select(\'' + n + '\')">'
          + '<span class="strip-dot ' + c.status + '"></span>' + esc(n) + '</span>';
      }

      headerEl.innerHTML = '<div class="info" style="font-size:13px;display:flex;align-items:center;width:100%">'
        + '<span style="color:#16a34a;font-weight:bold;margin-right:12px">openseed</span>'
        + '<span style="color:#999">' + names.length + ' creatures</span>'
        + '</div>';

      const narrationHtml = narrationEntries.map(renderNarrationEntry).join('');
      const momentsHtml = allMoments.map(renderMoment).filter(Boolean).join('');
      const hasNarration = narrationHtml.length > 0;
      contentEl.innerHTML = '<div class="overview">'
        + '<div class="status-strip">' + strip + '</div>'
        + '<div class="narration-feed" id="narrationFeed">'
        + (narrationHtml || '<div style="color:#999;padding:20px;text-align:center">Narrator is warming up...</div>')
        + '</div>'
        + '<div class="moments-toggle">'
        + '<button class="moments-toggle-btn" onclick="toggleMoments()">'
        + (showMoments ? '\u25bc hide raw events' : '\u25b6 show raw events (' + allMoments.length + ')')
        + '</button>'
        + '</div>'
        + '<div class="moments" id="momentsFeed" style="' + (showMoments ? '' : 'display:none;') + 'margin-top:12px">'
        + (momentsHtml || '<div style="color:#999;padding:20px;text-align:center">No creature activity yet.</div>')
        + '</div>'
        + '</div>';
    }

    function updateOverviewStrip() {
      if (selected !== null) return;
      const strip = contentEl.querySelector('.status-strip');
      if (!strip) return;
      const names = Object.keys(creatures).sort();
      let html = '';
      for (const n of names) {
        const c = creatures[n];
        html += '<span class="strip-item" onclick="select(\'' + n + '\')">'
          + '<span class="strip-dot ' + c.status + '"></span>' + esc(n) + '</span>';
      }
      strip.innerHTML = html;
    }

    function toggleMoments() {
      showMoments = !showMoments;
      const feed = document.getElementById('momentsFeed');
      if (feed) feed.style.display = showMoments ? '' : 'none';
      const btn = contentEl.querySelector('.moments-toggle-btn');
      if (btn) {
        btn.textContent = showMoments ? '\u25bc hide raw events' : '\u25b6 show raw events (' + allMoments.length + ')';
        btn.className = 'moments-toggle-btn' + (showMoments ? ' active' : '');
      }
    }

    async function startC(n) { await fetch('/api/creatures/'+n+'/start',{method:'POST'}); refresh(); }
    async function stopC(n) { await fetch('/api/creatures/'+n+'/stop',{method:'POST'}); refresh(); }
    async function restartC(n) { await fetch('/api/creatures/'+n+'/restart',{method:'POST'}); refresh(); }
    async function rebuildC(n) { if(confirm('Rebuild destroys the container environment. Continue?')) { await fetch('/api/creatures/'+n+'/rebuild',{method:'POST'}); refresh(); } }
    async function wakeC(n) { await fetch('/api/creatures/'+n+'/wake',{method:'POST'}); }
    function toggleSpawnForm() {
      document.getElementById('spawnForm').classList.toggle('visible');
      document.getElementById('spawnError').textContent = '';
    }

    async function spawnC() {
      const nameEl = document.getElementById('spawnName');
      const genomeEl = document.getElementById('spawnGenome');
      const modelEl = document.getElementById('spawnModel');
      const purposeEl = document.getElementById('spawnPurpose');
      const errEl = document.getElementById('spawnError');
      const btn = document.getElementById('spawnBtn');
      const name = nameEl.value.trim();
      if (!name) { errEl.textContent = 'name is required'; return; }
      btn.disabled = true;
      btn.textContent = 'spawning...';
      errEl.textContent = '';
      try {
        const body = { name, purpose: purposeEl.value.trim(), genome: genomeEl.value };
        if (modelEl.value) body.model = modelEl.value;
        const res = await fetch('/api/creatures', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        if (!res.ok) { errEl.textContent = await res.text(); return; }
        nameEl.value = '';
        genomeEl.selectedIndex = 0;
        modelEl.selectedIndex = 0;
        purposeEl.value = '';
        document.getElementById('spawnForm').classList.remove('visible');
        await refresh();
        select(name);
      } catch (e) { errEl.textContent = e.message; }
      finally { btn.disabled = false; btn.textContent = 'spawn'; }
    }

    async function archiveC(n) {
      if (!confirm('Archive creature "' + n + '"? It will be stopped and moved to the archive.')) return;
      await fetch('/api/creatures/' + n + '/archive', { method: 'POST' });
      await refresh();
      select(null);
    }

    async function sendMsg() {
      if (!selected) return;
      const inp = document.getElementById('msg');
      const text = inp.value.trim();
      if (!text) return;
      await fetch('/api/creatures/'+selected+'/message',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
      inp.value = '';
    }

    let usageData = {};
    let totalCost = 0;
    let creatureBudgets = {};

    async function refresh() {
      try {
        const fetches = [fetch('/api/creatures'), fetch('/api/usage')];
        if (selected) fetches.push(fetch('/api/creatures/' + selected + '/budget'));
        const [crRes, usRes, budgetRes] = await Promise.all(fetches);
        creatures = {};
        for (const c of await crRes.json()) creatures[c.name] = c;
        const ud = await usRes.json();
        usageData = ud.usage || {};
        totalCost = ud.total || 0;

        const names = Object.keys(creatures);
        const budgetResults = await Promise.all(
          names.map(n => fetch('/api/creatures/' + n + '/budget').then(r => r.json()).catch(() => null))
        );
        names.forEach((n, i) => { if (budgetResults[i]) creatureBudgets[n] = budgetResults[i]; });

        renderSidebar();
        if (selected === null) { updateOverviewStrip(); }
        if (selected && creatures[selected]) {
          const el = document.getElementById('cinfo');
          if (el) {
            const c = creatures[selected];
            const sr = c.sleepReason === 'budget' ? ' (budget cap)' : '';
            el.innerHTML = '<span class="sha">' + (c.sha||'-').slice(0,7) + '</span> \u00b7 ' + c.status + sr;
          }
          if (budgetRes && !document.getElementById('beCap')) {
            try { renderBudgetInfo(await budgetRes.json()); } catch {}
          }
        }
      } catch {}
    }

    async function loadGenomes() {
      try {
        const res = await fetch('/api/genomes');
        const genomes = await res.json();
        const sel = document.getElementById('spawnGenome');
        sel.innerHTML = genomes.map(g => '<option value="' + esc(g.name) + '">' + esc(g.name) + '</option>').join('');
      } catch {}
    }

    refresh().then(() => Promise.all([loadRecentEvents(), loadNarration()])).then(() => { if (selected === null) renderContent(); });
    loadGenomes();
    loadGlobalBudget().then(renderGlobalBudget);
    setInterval(refresh, 2000);
  </script>
</body>
</html>
